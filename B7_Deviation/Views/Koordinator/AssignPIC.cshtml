
@{
	ViewBag.Title = "AssignPIC";
	Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/Content/Styles/css/jquery.dataTables.min.css" rel="stylesheet" />
<script src="~/Content/Styles/js/jquery.dataTables.min.js" defer></script>

<body>
	<div class="content-body">
		<div class="form-group">
			<div class="container-fluid">
				<div class="card">

					<div class="card-body">
						<div class="form-group">
							<h2 class="d-inline">Assign PIC</h2>
						</div>

						<table class="table table-striped table-bordered zero-configuration nowrap table-responsive" width="100%" id="datatablepic">
							<thead>
								<tr>
									<th style="text-align:center">No</th>
									<th width="300px" style="text-align:center">Keterangan Disposisi</th>
									<th width="300px" style="text-align:center">Pelaksana</th>
									<th wdith="100px" style="text-align:center">Due Date</th>
									<th width="150px" style="text-align:center">Actions</th>
									<th hidden="hidden">No Disposisi</th>
								</tr>
							</thead>
							<tbody id="pictable" class="nowrap">
								<tr>
									<td align="center"></td>
								</tr>
							</tbody>
						</table>
						<br />
						<div class="row">
							<div class="col-8">
								<div class="form-group">
									<button id="goBack" class="btn btn-success" onclick="goBack()">Back</button>
								</div>
							</div>
							<div class="col-4" style="float:right;">
								<div class="form-group" id="evaluasiresiko">
									<label>Evaluasi Risiko</label>
									<div class="form-check">
										<input class="form-check-input" type="radio" name="radbut" id="flexRadioDefault1" value="Yes" disabled="disabled">
										<label class="form-check-label" for="flexRadioDefault1">
											Perlu Ditindaklanjuti dengan Pengkajian Risiko
										</label>
									</div>
									<div class="form-check">
										<input class="form-check-input" type="radio" name="radbut" id="flexRadioDefault2" value="No" disabled="disabled">
										<label class="form-check-label" for="flexRadioDefault2">
											Tidak Perlu Ditindaklanjuti dengan Pengkajian
										</label>
									</div>
								</div>
							</div>
						</div>
						
					</div>

				</div>
			</div>
		</div>

		<div class="form-group">
			<div class="container-fluid">
				<div class="card">
					<div class="card-body">
						
						<h4>Tabel Keterangan Review</h4>

						<div class="form-group">
							<table class="table table-striped table-bordered zero-configuration table-responsive" id="deviationdatatable" width="100%">
								<thead>
									<tr>
										<th width="100px" style="text-align:center">Nama</th>
										<th width="100px" style="text-align:center">NIK</th>
										<th width="200px" style="text-align:center">Status</th>
										<th width="200px" style="text-align:center">Tanggal Review</th>
										<th width="350px" style="text-align:center">Hasil Review</th>
										<th width="250px" style="text-align:center">Dokumen Pendukung</th>

									</tr>
								</thead>
								<tbody id="deviationtable" class="nowrap">
								</tbody>
							</table>


							<table class="table table-striped table-bordered zero-configuration nowrap table-responsive" id="reviewerbuktidatatable" width="100%" hidden="hidden">
								<thead>
									<tr>
										<th width="75px">No</th>
										<th width="100px">Nama Reviewer</th>
										<th width="75px">Nama File</th>

									</tr>
								</thead>
								<tbody id="reviewerbukti" class="nowrap">
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	   

	</div>

</body>

<script>
	$(document).ready(function () {

		LoadData();
		LoadData2();
	});

	function goBack() {
		window.location.href = "../DataDeviasi/PendingTask"
	}

	function Cancel(button) {

		LoadData();
	}

	function ShowBukti(button) {
			event.preventDefault();

			$("#reviewerbuktidatatable").removeAttr("hidden");

			var row = $(button).closest("TR");
			var ReqID = @ViewBag.nomor;
			var reviewer = $("TD", row).eq(1).html();

			var dto = {
				REQID: ReqID,
				USER_NIK: reviewer
			}

			$.ajax({
				url: "../Koordinator/Coor_ShowReviewerBukti",
				type: "post",
				dataType: "json",
				data: JSON.stringify(dto),
				contentType: "application/json;charset=utf-8",
				success: function (data) {
					var trHTML = '';
					var trav = 0;
					var Count = data.length;

					if (Count == '0') {
						trHTML +=
							'<tr><td> - </td>' +
							'<td> N/A </td>' +
							'<td> N/A </td>';
					} else {
						for (trav = 0; trav < Count; trav++) {
							var no = 1;
							no = no + trav;
							trHTML +=
								'<tr><td>' + no + '</td>' +
								'<td>' + data[trav].REVIEWER_NIK + '</td>' +
								'<td><a href="../' + data[trav].PATH_FILE + '" download="' + data[trav].PATH_FILE + '">' + data[trav].FILE_NAME_UPLOAD + '</a></td>';

						}
					}



					$('#reviewerbukti').empty();
					$('#reviewerbukti').append(trHTML);
					$('#reviewerbuktidatatable').DataTable();

				}
				, error: function (ex) {
					alert('Error Delete User Involved : ' + JSON.stringify(ex));
				}
			});
		}

		// Check Status to Determine which Row Has Action
		function LoadData2() {
			var REQID = @ViewBag.nomor;

			var dto = {
				REQID: REQID
			};

			$.ajax({
				url: "../Koordinator/Coor_LoadReviewerList",
				type: "post",
				dataType: "json",
				data: JSON.stringify(dto),
				contentType: "application/json;charset=utf-8",
				success: function (data) {

					var trHTML = '';
					var trav = 0;
					var Count = data.length;
					for (trav = 0; trav < Count; trav++) {

						// WHEN REVIEWER FINISHED REVIEW / REVISE

							trHTML +=
								'<tr><td>' + data[trav].USER_NAME + '</td>' +
								'<td>' + data[trav].USER_NIK + '</td>' +
								'<td>' + data[trav].FLAG_REVIEW + '</td>' +
								'<td style="text-align:center">' + data[trav].TANGGAL + '</td>' +
								'<td>' + data[trav].KETERANGAN_REVIEW + '</td>' ;


						trHTML += '<td align="center"><button onclick="ShowBukti(this)" class="btn btn-info">View</button ></td ></tr > ';

						$('#deviationtable').empty();
						$('#deviationtable').append(trHTML);
						$('#deviationdatatable').DataTable();
					}



				}, error: function (ex) {
					alert(JSON.stringify(ex));
				}
			});
		}

	function AssignPIC(button) {

		var row = $(button).closest("TR");
		var pic_nik = $("TD", row).eq(2).find("select").val();

		var REQID = @ViewBag.nomor;

		var dtx = {
			REQID: REQID,
			UserInvolved: pic_nik
		}

		$.ajax({
			url: "../Form/CheckEmailAvailability",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dtx),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
				if (data == 'ADA') {

					var due_date = $("TD", row).eq(3).find("input[type='date']").val();
					var no_disposisi = $("TD", row).eq(5).find("input[type='text']").val();

					var req_id = @ViewBag.nomor;
					var curr_user = '@Request.RequestContext.HttpContext.Session["xUser"]';

					if (pic_nik == null || due_date == '') {
						Swal.fire({
							icon: 'error',
							title: 'Oops...',
							text: 'Nama Pelaksana dan Tanggal Due Date Tidak Boleh Kosong'
						});
						return;
					}

					var dto = {
						REQ_ID: req_id,
						PIC_REMEDIAL_NIK: pic_nik,
						DUE_DATE: due_date,
						NO_DISPOSISI: no_disposisi,
						CURR_USER: curr_user
					}

					$.ajax({
						url: "../Koordinator/Coor_AssignPIC",
						type: "post",
						dataType: "json",
						data: JSON.stringify(dto),
						contentType: "application/json;charset=utf-8",
						success: function (data) {

							toastr.success("Assign PIC Berhasil!", "Tersimpan", {
								"closeButton": false,
								"debug": true,
								"newestOnTop": false,
								"progressBar": false,
								"positionClass": "toast-top-right",
								"preventDuplicates": false,
								"onclick": null,
								"showDuration": "100",
								"hideDuration": "1000",
								"timeOut": "1000",
								"extendedTimeOut": "1000",
								"showEasing": "swing",
								"hideEasing": "linear",
								"showMethod": "fadeIn",
								"hideMethod": "fadeOut"
							});

							LoadData();
						}
						, error: function (ex) {
							alert('Error Delete Attachment: ' + JSON.stringify(ex));
						}
					});


					var receiver = $("TD", row).eq(2).find("select").val();

					var tabletype = "One";
					var whoreceiver = "PIC after Appointed";

					var dtx = {
						Receiver: receiver,
						ReqID: REQID,
						TableType: tabletype,
						WhoReceiver: whoreceiver
					};

					$.ajax({
						type: "post",
						url: '../Form/SendEmailInputProposal',
						data: JSON.stringify(dtx),
						dataType: "json",
						contentType: "application/json;charset=utf-8",
						success: function (data) {

						}, error: function (ex) {
							alert("Error Email: " + JSON.stringify(ex));
						}
					});

				} else {

					Swal.fire({
						icon: 'error',
						title: 'Oops...',
						text: 'Nama Pelaksana Kosong/Email Pelaksana Tidak Tersedia'
					});


				}
			}
			, error: function (ex) {
				alert('Check Email Availability: ' + JSON.stringify(ex));
			}
		});


	}

	function LoadData() {

		var nomor = @ViewBag.nomor;

		var dto = {
			REQ_ID: nomor
		}

		// GET DISPOSISI TABLE FOR ASSIGNING PIC
		$.ajax({
			url: "../Koordinator/Coor_LoadDisposisiData",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
				var trHTML = '';
				var trav = 0;
				var Count = data.length;
				for (trav = 0; trav < Count; trav++) {
					var no = trav + 1;

					if (data[trav].PIC_REMEDIAL_NIK == '-' && data[trav].PIC_REMEDIAL_NAME == 'NOT YET ASSIGNED') {
						trHTML += '<tr><td align="center">' + no + '</td>' +
							'<td>' + data[trav].KETERANGAN_DISPOSISI + '</td>' +
							'<td> <select id="pic' + trav + '"></td>' +
							'<td> <input type="date" id="duedate' + trav + '"></td>' +
							'<td align="center"> <input type="button" id="AssignPIC" value="Assign PIC" onclick=AssignPIC(this) class="btn btn-primary" style="width:100px;"/></td>' +
							'<td hidden="hidden"><input type="text" value="' + data[trav].NO_DISPOSISI + '"</td>';

					} else {
						trHTML += '<tr><td align="center">' + no + '</td>' +
							'<td>' + data[trav].KETERANGAN_DISPOSISI + '</td>' +
							'<td>' + data[trav].PIC_REMEDIAL_NAME + '</td>' +
							'<td>' + data[trav].DUE_DATE + '</td>' +
							'<td align="center">* NO ACTIONS *</td>' +
							'<td hidden="hidden"><input type="text" value="' + data[trav].NO_DISPOSISI + '"</td>';
					}


				}

				$('#pictable').empty();
				$('#pictable').append(trHTML);
				$('#datatablepic').DataTable();

				var jumlahdisposisi = trav;

				LoadPICList(jumlahdisposisi);
			},
			error: function (ex) {
				alert(JSON.stringify(ex));
			}
		});

        var dtx = {
            REQID: nomor
        }

		// GET EVALUASI RESIKO 
		$.ajax({
			url: "../Koordinator/LoadEvaluasiResiko",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dtx),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
				$("input[name=radbut][value=" + data[0].EVALUASI_RESIKO + "]").prop('checked', true);
			},
			error: function (ex) {
				alert(JSON.stringify(ex));
			}
		});
	}

	function LoadPICList(jumlahdisposisi) {
		$.ajax({
			url: "../Koordinator/Coor_LoadPICList",
			type: "post",
			dataType: "json",
			contentType: "application/json;charset=utf-8",
			success: function (data) {

				var trhtml = "";
				var trav = 0;
				var count = data.length;

				trhtml += '<option disabled class="dropdown-header" value="" selected>Select PIC</option>';
				if (count > 0) {
					for (trav = 0; trav < count; trav++) {
						trhtml +=
							'<option class="dropdown-item" value = "' + data[trav].EmpId + '">' + data[trav].EmpName + '</option>';
					}
				}

				var i = 0;

				// Populate PIC Dropdown Lists
				for (i = 0; i < jumlahdisposisi; i++) {
					$("#pic" + i).empty();
					$("#pic" + i).append(trhtml);
					$("#pic" + i).select2();
				}


			}, error: function (ex) {
				alert(JSON.stringify(ex));
			}
		});
	}

</script>
