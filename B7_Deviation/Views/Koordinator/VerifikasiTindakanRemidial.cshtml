
@{
	ViewBag.Title = "VerifikasiTindakanRemidial";
	Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/Content/Styles/css/jquery.dataTables.min.css" rel="stylesheet" />
<script src="~/Content/Styles/js/jquery.dataTables.min.js" defer></script>

<div class="content-body">
	<div class="form-group">
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-12">
					<div class="card">
						<div class="card-body">

							<div class="form-group">
								<h4 class="d-inline">Laporan Penyimpangan / Potensi Penyimpangan</h4>
							</div>

							<div class="form-group row">
								<div class="col-md-8">
									<div class="form-group">

										<button type="button" id="btnCancel" class="col-sm-2 btn mb-1 btn-danger form-control ">
											Cancel
											<span class="fa fa-check-square-o"></span>
										</button>

									</div>
								</div>
								<div class="col-md-4">
									<div class="form-group">
										<label>Nama</label>
										<input id="xdxdxdxd" type="text" class="form-control" readonly="readonly" value="@Request.RequestContext.HttpContext.Session["fullname"]">
									</div>
									<div class="form-group">
										<label for="txtTanggal">Tanggal:</label>
										<input class="form-control" readonly="readonly" value="@System.DateTime.Now.ToString("dd-MM-yyyy")" />
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

	</div>

	<div class="form-group">
		@Html.Partial("~/Views/QualityManager/QualityManagerPartialView.cshtml")
	</div>

	<div class="form-group">
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-12">
					<div class="card">
						<div class="card-body">

							<table class="table table-bordered table-hover nowrap table-responsive" id="deviationdatatable" width="100%">
								<thead>
									<tr>
										<th rowspan="2">No</th>
										<th rowspan="2">Usulan Tindakan Remedial</th>
										<th rowspan="2">Hasil Tindakan Remedial</th>
										<th colspan="4" style="text-align:center">Testing Cost</th>
										<th colspan="3" style="text-align:center">Processing Cost</th>
										<th colspan="3" style="text-align:center">Reject Cost</th>
										<th colspan="2" style="text-align:center">Machine Cost</th>
										<th rowspan="2" style="text-align:center">PIC</th>
										<th rowspan="2" style="text-align:center">Dokumen Pendukung</th>
										<th id="headVerify" rowspan="2" style="text-align:center">Verifikasi Tindakan Remedial</th>
									</tr>
									<tr>
										<th width="75px">Jumlah Personel</th>
										<th width="75px">Durasi Pengerjaan (Jam)</th>
										<th width="75px">Manhours Value</th>
										<th width="150px">Cost of Analysis</th>
										<th width="75px">Durasi Pengerjaan</th>
										<th width="75px">Jumlah Pelaksana (Jam)</th>
										<th width="75px">Manhours Value</th>
										<th width="75px">Material</th>
										<th width="75px">Quantity</th>
										<th width="75px">Cost Material</th>
										<th width="75px">Nama Sparepart</th>
										<th width="75px">Harga Sparepart</th>
										<th width="75px" hidden="hidden">NIK PIC</th>
									</tr>

								</thead>
								<tbody id="deviationtable">
								</tbody>
								<tfoot id="picfooter">
									<tr>
										<th colspan="3" style="text-align: center; text ; background-color: #f3f3f3">Total</th>
										<th colspan="3" style="text-align: center; background-color: #f3f3f3">Total Testing Manhours</th>
										<th style="text-align: center; background-color: #f3f3f3">Total Testing Cost</th>
										<th colspan="3" style="text-align: center; background-color: #f3f3f3">Total Processing Manhours</th>
										<th colspan="3" style="text-align: center; background-color: #f3f3f3">Total Rejected Cost</th>
										<th colspan="2" style="text-align: center; background-color: #f3f3f3">Total Machine Cost</th>
									</tr>
									
								</tfoot>
							</table>
						</div>


					</div>
					<div class="card" id="tabel2" hidden="hidden">
						<div class="card-body">
							<table class="table table-striped table-bordered zero-configuration nowrap table-responsive" id="buktidatatable" width="100%">
								<thead>
									<tr>
										<th width="75px">No</th>
										<th width="100px">NIK PIC</th>
										<th width="75px">Nama File</th>

									</tr>
								</thead>
								<tbody id="buktitable" class="nowrap">
								</tbody>
							</table>

						</div>
					</div>

				</div>
			</div>
		</div>
	</div>

	<div class="form-group">
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-12">
					<div class="card">
						<div class="card-body">
							<div class="form-group row">
								<div class="col-md-12">
									<div class="form-group">
										<label for="usulantindakan">
											Usulan Tindakan Remedial
										</label>
										<textarea id="usulantindakan" class="form-control" disabled="disabled"></textarea>
									</div>
								</div>
							</div>

							<div class="form-group" id="evaluasiresiko">
								<label>Evaluasi Risiko</label>
								<div class="form-check">
									<input class="form-check-input" type="radio" name="radbut" id="flexRadioDefault1" value="Yes" disabled="disabled">
									<label class="form-check-label" for="flexRadioDefault1">
										Perlu Ditindaklanjuti dengan Pengkajian Risiko
									</label>
								</div>
								<div class="form-check">
									<input class="form-check-input" type="radio" name="radbut" id="flexRadioDefault2" value="No" disabled="disabled">
									<label class="form-check-label" for="flexRadioDefault2">
										Tidak Perlu Ditindaklanjuti dengan Pengkajian
									</label>
								</div>
							</div>

						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="form-group" id="koorsubmission" hidden="hidden">
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-12">
					<div class="card">
                        <div class="card-body">
                            <h4>Investigation Time</h4>
                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label">Durasi Pengerjaan (Jam)<span class="text-danger">*</span></label>
                                <div class="col-sm-10">
                                    <input type="number" id="ITDP" class="form-control" />
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label">Jumlah Pelaksana (Orang)<span class="text-danger">*</span></label>
                                <div class="col-sm-10">
                                    <input type="number" id="ITJP" class="form-control" />
                                </div>
                            </div>

                        </div>
                        <div class="card-body">
                            <h4>Meeting Time</h4>
                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label">Durasi Pengerjaan (Jam)<span class="text-danger">*</span></label>
                                <div class="col-sm-10">
                                    <input type="number" id="MTDP" class="form-control" />
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label">Jumlah Pelaksana (Orang)<span class="text-danger">*</span></label>
                                <div class="col-sm-10">
                                    <input type="number" id="MTJP" class="form-control" />
                                </div>
                            </div>
                        </div>
						<div class="card-body">


							<button type="button" id="btnApprove" class="col-sm-2 btn btn-success">
								Save
								<span class="fa fa-check-square-o"></span>
							</button>
							

						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

</div>

<script>
	$(document).ready(function () {
		CheckFormStatus();
		GetUsulanTindakan();
		LoadStatus();

		
		$("#btnCancel").click(function () {
			Cancel();
		});

		$("#btnApprove").click(function () {
			Approve();
		});

		$("#btnReject").click(function () {
			Reject();
		});

	});

	function GetUsulanTindakan() {
		var REQID = @ViewBag.nomor;

		var dto = {
			REQID: REQID
		};

		$.ajax({
			url: "../QualityManager/QM_GetUsulanTindakan",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
				document.getElementById('usulantindakan').value = data[0].USULAN_REMIDIAL;

			}, error: function (ex) {
				alert(JSON.stringify(ex));
			}
		});

	}

	function LoadStatus() {
		var REQID = @ViewBag.nomor;

		var dto = {
			REQID: REQID
		};

		$.ajax({
			url: "../Koordinator/Koor_LoadVerifStatus",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
				if (data == 'VERIFIED') {
                    LoadData();
					$("#koorsubmission").removeAttr("hidden");                   
				} else {
                    LoadData();
					$("#koorsubmission").attr("hidden", true);
				}

			}, error: function (ex) {
				alert(JSON.stringify(ex));
			}
		});

	}

	function LoadData() {

		var nomor = @ViewBag.nomor;
		var dto = {
			REQID: nomor
		}

		$.when(
			$.ajax({
				url: "../Koordinator/Coor_LoadPICData",
				type: "post",
				data: JSON.stringify(dto),
				dataType: "json",
				contentType: "application/json;charset=utf-8",
				success: function (data) {
					var checkVerify = 0;
					var trHTML = '';
					var trav = 0;
					var Count = data.length;
					for (trav = 0; trav < Count; trav++) {
						var counter = 1;
						counter += trav;
						trHTML +=
							'<tr><td align="center">' + counter + '</td>' +
							'<td>' + data[trav].KETERANGAN_DISPOSISI + '</td>' +
							'<td>' + data[trav].HASIL_TINDAKAN + '</td>' +
							'<td>' + data[trav].TESTING_DURASI_PENGERJAAN + '</td>' +
							'<td>' + data[trav].TESTING_JUMLAH_PELAKSANA + '</td>' +
							//'<td>' + data[trav].TESTING_DURASI_PENGERJAAN * data[trav].TESTING_JUMLAH_PELAKSANA  + '</td>' +
							'<td>' + data[trav].MANHOURS_VALUE_TESTING + '</td>' +
							'<td align="right">' + data[trav].TESTING_COST_OF_ANALYSIS + '</td>' +
							'<td>' + data[trav].PROC_DURASI_PENGERJAAN + '</td>' +
							'<td>' + data[trav].PROC_JUMLAH_PELAKSANA + '</td>' +
							//'<td>' + data[trav].PROC_DURASI_PENGERJAAN * data[trav].PROC_JUMLAH_PELAKSANA + '</td>' +
							'<td>' + data[trav].MANHOURS_VALUE_PROCESSING + '</td>' +
							'<td>' + data[trav].REJ_MATERIAL + '</td>' +
							'<td>' + data[trav].REJ_QUANTITY + '</td>' +
							'<td>' + data[trav].REJ_COST_MATERIAL + '</td>' +
							'<td>' + data[trav].MC_SPAREPART + '</td>' +
							'<td>' + data[trav].MC_TOTAL_HARGA_SPAREPART + '</td>' +
							'<td>' + data[trav].PIC_REMEDIAL_NAME + '</td>' +
							'<td hidden="hidden">' + data[trav].PIC_REMEDIAL_NIK + '</td>';

						if (data[trav].FLAG_PIC == 'REJECTED' || data[trav].FLAG_PIC == null || data[trav].FLAG_PIC == 'ASSIGNED') {
							trHTML +=
								'<td> - </td>';

						} else {
							trHTML +=
								'<td align="center"><button onclick="ShowBukti(this)" class="btn btn-info"><span class="fa fa-info"><strong></strong></span></button ></td > ';
						}

						if ((data[trav].FLAG_VERIFIKASI == '-' && data[trav].FLAG_PIC == 'REMEDIAL ACCEPTED BY SPV PIC') ||
							(data[trav].FLAG_VERIFIKASI == 'REJECTED' && data[trav].FLAG_PIC == 'REMEDIAL ACCEPTED BY SPV PIC')) {
							trHTML +=
								'<td align="center">' +
								'<button style="width:50px" onclick = "Verifikasi(this)" class="btn btn-success">Verifikasi</button>' +
								'<button style="width:50px" onclick = "RejectVerifikasi" class="btn btn-danger" >Reject</button>' +
								'</td > ';
                        } else if ((data[trav].FLAG_VERIFIKASI == 'VERIFIED' && data[trav].FLAG_PIC == 'REMEDIAL ACCEPTED BY SPV PIC'))
						{
                            trHTML += '<td align="center"><img src="../Content/Pict/verified4.png" /></td>';
						} else {
							trHTML += '<td> N/A </td>';
						}

                        if (data[trav].FLAG_VERIFIKASI == 'VERIFIED') {
							checkVerify = checkVerify + 1;							
						}
					}

					$('#deviationdatatable').DataTable().clear().destroy();
					$('#deviationtable').empty();
					$('#deviationtable').append(trHTML);
					$('#deviationdatatable').DataTable({
						"searching": false,
						"paging": false,
						"info": false,
						"ordering": false
					});

					if (checkVerify > 0) {
                        $('#headVerify').focus();
					}
                    

				},
				error: function (ex) {
					alert(JSON.stringify(ex));
				}
			})
        ).done(
				$.ajax({
					url: "../Koordinator/Coor_LoadPICDataFooter",
					type: "post",
					data: JSON.stringify(dto),
					dataType: "json",
					contentType: "application/json;charset=utf-8",
					success: function (data) {
						var trHTML = '';
						var trav = 0;
						var Count = data.length;
						for (trav = 0; trav < Count; trav++) {

							trHTML +=
								'<tr>' +
								'<td style="background-color: #f3f3f3" colspan="3"></td><td colspan="3" style="text-align:center">' + data[0].TOTAL_TESTING_MANHOURS + '</td>' +
								'<td colspan="1" style="text-align:center"> Rp. ' + data[0].TOTAL_TESTING_COA + '</td>' +
								'<td colspan="3" style="text-align:center">' + data[0].TOTAL_PROC_MAHOURS + '</td>' +
								'<td colspan="3" style="text-align:center"> Rp. ' + data[0].TOTAL_REJ_COST + '</td>' +
								'<td colspan="2" style="text-align:center"> Rp. ' + data[0].TOTAL_MC_HARGA_SPAREPART + '</td></tr>' +


								'<tr><th colspan = "13" style="text-align:center;background-color: #f3f3f3">Total Times</th>' +
								'<td colspan="2" style="text-align:center">' + data[trav].TOTAL_TIMES + '</td></tr>' +

								'<tr><th colspan = "13" style="text-align:center;background-color: #f3f3f3">Total Cost</th>' +
								'<td colspan="2" style="text-align:center"> Rp. ' + data[trav].TOTAL_COST + '</td></tr>';


						}

						// NO NEED TO DECLARE DATA TABLE COZ FOOTER IS FOOTER AND THE TABLE IS NOT GONNA CHANGE ANYWAY
                        $('#picfooter').empty();
						$('#picfooter').append(trHTML);


					},
					error: function (ex) {
						alert(JSON.stringify(ex));
					}
				})
		);

		

		// GET EVALUASI RESIKO
		$.ajax({
			url: "../Koordinator/LoadEvaluasiResiko",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
				$("input[name=radbut][value=" + data[0].EVALUASI_RESIKO + "]").prop('checked', true);
			},
			error: function (ex) {
				alert(JSON.stringify(ex));
			}
		});

	};

	function Verifikasi(button) {
		var row = $(button).closest("TR");
		var ReqID = @ViewBag.nomor;
		var no_disposisi = $("TD", row).eq(0).html();

		var dto = {
			REQ_ID: ReqID,
			NO_DISPOSISI: no_disposisi
		}

		$.ajax({
			url: "../Koordinator/VerifikasiPerPIC",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
                LoadStatus();
				
			}
			, error: function (ex) {
				alert('Error Delete User Involved : ' + JSON.stringify(ex));
			}
		});
	}

	function RejectVerifikasi(button) {
		var row = $(button).closest("TR");
		var ReqID = @ViewBag.nomor;
		var no_disposisi = $("TD", row).eq(0).html();

		var dto = {
			REQ_ID: ReqID,
			NO_DISPOSISI: no_disposisi
		}

		$.ajax({
			url: "../Koordinator/RejectVerifikasiPerPIC",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
				alert("Not Verified");
                LoadStatus();
			}
			, error: function (ex) {
				alert('Error Delete User Involved : ' + JSON.stringify(ex));
			}
		});
	}


	function ShowBukti(button) {
		event.preventDefault();
		var row = $(button).closest("TR");
		var ReqID = @ViewBag.nomor;
		var picnik = $("TD", row).eq(16).html();

		var dto = {
			REQID: ReqID,
			IDUSER: picnik
		}

		$.ajax({
			url: "../Koordinator/Coor_ShowBuktiTable",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
				var trHTML = '';
				var trav = 0;
				var Count = data.length;

				if (Count == '0') {
					trHTML +=
						'<tr><td> - </td>' +
						'<td> - </td>' +
						'<td> - </td>';

				} else {
					for (trav = 0; trav < Count; trav++) {
						var no = 1;
						no = no + trav;
						trHTML +=
							'<tr><td>' + no + '</td>' +
							'<td>' + data[trav].PIC_ID + '</td>' +
							'<td><a href="../' + data[trav].PATH_FILE + '" download="' + data[trav].PATH_FILE + '">' + data[trav].FILE_NAME_UPLOAD + '</a></td>';

					}
				}

                $('#buktidatatable').DataTable().clear().destroy();

				$('#buktitable').empty();
				$('#buktitable').append(trHTML);
				$('#buktidatatable').DataTable({
                    "searching": false,
                    "paging": false,
                    "info": false,
                    "ordering": false
				});

				$("#tabel2").removeAttr("hidden");
			}
			, error: function (ex) {
				alert('Error Delete User Involved : ' + JSON.stringify(ex));
			}
		});
	}

	function CheckFormStatus() {
		var REQID = @ViewBag.nomor;

		var dto = {
			REQID: REQID

		};

		$.ajax({
			url: "../Koordinator/Coor_CheckFormStatus",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {

				

			}, error: function (ex) {
				alert(JSON.stringify(ex));
			}
		});
	}

	function Cancel() {
		Swal.fire({
			title: 'Cancel Reason ...',
			input: 'text',
			inputAttributes: {
				autocapitalize: 'off'
			},
			showCancelButton: true,
			confirmButtonText: 'Submit',
			showLoaderOnConfirm: true,

			allowOutsideClick: () => Swal.isLoading()
		}).then((result) => {

			if (result.value == null || result.value == '') {
				Swal.fire({
					icon: 'error',
					title: 'Oops...',
					text: 'Please Insert Reason!'
				});
			} else if (result.isConfirmed) {

				var REQID = @ViewBag.nomor;
				var Keterangan = result.value;
				var iduser = '@Request.RequestContext.HttpContext.Session["xUser"]';

				var dto = {
					REQID: REQID,
					KETERANGAN: Keterangan,
					IDUSER: iduser
				};

				$.ajax({
					url: "../Koordinator/Coor_KoorCancel",
					type: "post",
					dataType: "json",
					data: JSON.stringify(dto),
					contentType: "application/json;charset=utf-8",
					success: function (data) {

						alert('Form Canceled');
						window.location.href = "../DataDeviasi/PendingTask"

					}
					, error: function (ex) {

					}
				});

				var receiver = '@Request.RequestContext.HttpContext.Session["xUser"]';

				var tabletype = "One";
				var whoreceiver = "Canceled";

				var dtx = {
					Receiver: receiver,
					ReqID: REQID,

					TableType: tabletype,
					WhoReceiver: whoreceiver
				};

				$.ajax({
					type: "post",
					url: '../Form/SendEmailInputProposal',
					data: JSON.stringify(dtx),
					dataType: "json",
					contentType: "application/json;charset=utf-8",
					success: function (data) {

					}, error: function (ex) {
						alert("Error Email: " + JSON.stringify(ex));
					}
				});
			}
		});
	}

	function Approve() {
		var REQID = @ViewBag.nomor;
		var iduser = '@Request.RequestContext.HttpContext.Session["xUser"]';

		var itdp = $("#ITDP").val();
		var itjp = $("#ITJP").val();
		var mtdp = $("#MTDP").val();
		var mtjp = $("#MTJP").val();

		if (itdp == '' || itjp == '' || mtdp == '' || mtjp == '') {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Investigation Time atau Meeting Time tidak boleh kosong !',
            })
            return;
		}

		var dto = {

			REQID: REQID,
			IDUSER: iduser,
			ITDP: itdp,
			ITJP: itjp,
			MTDP: mtdp,
			MTJP: mtjp
		};

		$.ajax({
			url: "../Koordinator/Coor_ApprovePIC",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {

				Swal.fire({
					title: 'Form Approved',
					icon: 'success',
					showDenyButton: false,
					showCancelButton: false,
					confirmButtonText: `OK`
				}).then((result) => {

					if (result.isConfirmed) {
						window.location.href = "../DataDeviasi/PendingTask"
					}
				});

			}
			, error: function (ex) {

			}
		});
		var receiver = '@Request.RequestContext.HttpContext.Session["xUser"]';
		var tabletype = "More Than One";
		var whoreceiver = "QM after Koordinator Verifikasi OK";

		var dtx = {
			Receiver: receiver,
			ReqID: REQID,
			TableType: tabletype,
			WhoReceiver: whoreceiver
		};

		$.ajax({
			type: "post",
			url: '../Form/SendEmailInputProposal',
			data: JSON.stringify(dtx),
			dataType: "json",
			contentType: "application/json;charset=utf-8",
			success: function (data) {

			}, error: function (ex) {
				alert("Error Email: " + JSON.stringify(ex));
			}
		});

	}

	function Reject() {

		Swal.fire({
			title: 'Reason???',
			input: 'text',
			inputAttributes: {
				autocapitalize: 'off'
			},
			showCancelButton: true,
			confirmButtonText: 'Submit',
			showLoaderOnConfirm: true,

			allowOutsideClick: () => Swal.isLoading()
		}).then((result) => {

			if (result.value == null || result.value == '') {
				Swal.fire({
					icon: 'error',
					title: 'Oops...',
					text: 'Please Insert Reason!'
				});
			} else if (result.isConfirmed) {

				var REQID = @ViewBag.nomor;
				var Keterangan = result.value;
				var iduser = '@Request.RequestContext.HttpContext.Session["xUser"]';

				var dto = {
					REQID: REQID,
					KETERANGAN: Keterangan,
					IDUSER: iduser
				};

				$.ajax({
					url: "../Koordinator/Coor_Reject",
					type: "post",
					dataType: "json",
					data: JSON.stringify(dto),
					contentType: "application/json;charset=utf-8",
					success: function (data) {

						Swal.fire({
							title: 'Form Rejected',
							icon: 'success',
							showDenyButton: false,
							showCancelButton: false,
							confirmButtonText: `OK`
						}).then((result) => {

							if (result.isConfirmed) {
								window.location.href = "../DataDeviasi/PendingTask"
							}
						});

					}
					, error: function (ex) {
						alert('Error Delete Attachment: ' + JSON.stringify(ex));
					}
				});


				var receiver = '@Request.RequestContext.HttpContext.Session["xUser"]';

				var tabletype = "More Than One";
				var whoreceiver = "QM after Koordinator Verifikasi Not OK";

				var dtx = {
					Receiver: receiver,
					ReqID: REQID,
					TableType: tabletype,
					WhoReceiver: whoreceiver
				};

				$.ajax({
					type: "post",
					url: '../Form/SendEmailInputProposal',
					data: JSON.stringify(dtx),
					dataType: "json",
					contentType: "application/json;charset=utf-8",
					success: function (data) {

					}, error: function (ex) {
						alert("Error Email: " + JSON.stringify(ex));
					}
				});

			}

		});
	}


</script>
